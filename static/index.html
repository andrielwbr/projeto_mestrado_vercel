<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <title>RunAI - Acesso Seguro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background: #f1f5f9; height: 100vh; display: flex; align-items: center; justify-content: center; }
        
        /* TELA DE LOGIN */
        .auth-container { width: 100%; max-width: 400px; padding: 20px; }
        .auth-card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .brand { color: #2563eb; font-weight: 800; font-size: 1.5rem; text-align: center; margin-bottom: 20px; }
        
        /* TELA DO APP (Escondida no in√≠cio) */
        .app-wrapper { display: none; width: 100%; max-width: 500px; padding: 20px; height: 100%; overflow-y: auto; }
        .main-card { background: white; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); overflow: hidden; margin-top: 20px; }
        .header { background: #0f172a; color: white; padding: 25px; text-align: center; position: relative; }
        .logout-btn { position: absolute; top: 15px; right: 15px; font-size: 0.8rem; background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 8px; cursor: pointer; }
        
        /* RESULTADO */
        .prescription-card { background: #fff; border-radius: 15px; border: 1px solid #e2e8f0; padding: 20px; margin-top: 20px; display: none; animation: slideUp 0.5s; }
        .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; display: inline-block; margin-bottom: 10px; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

<div id="authScreen" class="auth-container">
    <div class="auth-card">
        <div class="brand">RunAI üîê</div>
        <h5 class="text-center mb-4 text-muted">Acesso ao Treinador</h5>
        
        <div class="form-floating mb-3">
            <input type="email" class="form-control" id="email" placeholder="nome@exemplo.com">
            <label>Email</label>
        </div>
        <div class="form-floating mb-3">
            <input type="password" class="form-control" id="password" placeholder="Senha">
            <label>Senha</label>
        </div>

        <button onclick="fazerLogin()" class="btn btn-primary w-100 py-3 fw-bold mb-2">ENTRAR</button>
        <button onclick="criarConta()" class="btn btn-outline-secondary w-100 py-2 btn-sm">Criar nova conta</button>
        
        <div id="authMsg" class="text-center mt-3 small text-danger"></div>
    </div>
</div>

<div id="appScreen" class="app-wrapper">
    <div class="main-card">
        <div class="header">
            <button onclick="sair()" class="logout-btn">Sair üö™</button>
            <h2 class="m-0 fw-bold">RunAI Coach</h2>
            <small id="userDisplay" style="opacity: 0.8">Ol√°, Atleta</small>
        </div>

        <div class="p-4">
            <form onsubmit="event.preventDefault(); enviarTreino();">
                
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <input type="number" class="form-control" id="idade" placeholder="Sua Idade" required>
                    </div>
                    <div class="col-6">
                        <select class="form-select" id="nivel">
                            <option value="iniciante">Sou Iniciante</option>
                            <option value="avancado">J√° Corro</option>
                        </select>
                    </div>
                </div>

                <hr class="my-4">

                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <div class="form-floating">
                            <input type="number" class="form-control" id="km" step="0.1" required>
                            <label>Dist√¢ncia (km)</label>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="form-floating">
                            <input type="number" class="form-control" id="tempo" required>
                            <label>Tempo (min)</label>
                        </div>
                    </div>
                </div>

                <label class="form-label d-flex justify-content-between small text-muted fw-bold">
                    <span>INTENSIDADE (PERCEP√á√ÉO)</span>
                    <span id="valorEsforco" class="text-primary">5</span>
                </label>
                <input type="range" class="form-range" min="1" max="10" id="esforco" value="5" oninput="document.getElementById('valorEsforco').innerText = this.value">

                <button type="submit" class="btn btn-dark w-100 py-3 mt-3 fw-bold" id="btnEnviar">ANALISAR PERFORMANCE</button>
            </form>

            <div id="resultado" class="prescription-card">
                <div id="statusBadge" class="status-badge"></div>
                <h5 class="fw-bold mb-2">An√°lise T√©cnica</h5>
                <p id="msgAnalise" class="text-muted small"></p>
                <hr>
                <div class="row text-center mt-3">
                    <div class="col-6 border-end">
                        <small class="text-uppercase text-muted fw-bold" style="font-size: 0.7rem">A√ß√£o</small>
                        <div id="acaoRecomendada" class="fw-bold text-dark mt-1"></div>
                    </div>
                    <div class="col-6">
                        <small class="text-uppercase text-muted fw-bold" style="font-size: 0.7rem">Pr√≥ximo</small>
                        <div id="proximoTreino" class="fw-bold text-primary mt-1"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- CONFIGURA√á√ÉO DE SEGURAN√áA ---
    // COPIE E COLE AQUI AS MESMAS CHAVES QUE VOC√ä COLOCOU NA VERCEL
    const SUPABASE_URL = 'https://SEU_PROJETO.supabase.co'; // <--- TROQUE AQUI
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5c...';    // <--- TROQUE PELA CHAVE ANON/PUBLIC AQUI
    
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let usuarioAtual = null;

    // --- L√ìGICA DE LOGIN ---
    async function fazerLogin() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        
        if (error) {
            document.getElementById('authMsg').innerText = "Erro: " + error.message;
        } else {
            entrarNoApp(data.user);
        }
    }

    async function criarConta() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        
        const { data, error } = await supabase.auth.signUp({ email, password });
        
        if (error) {
            document.getElementById('authMsg').innerText = "Erro: " + error.message;
        } else {
            alert("Conta criada! Verifique se j√° pode logar.");
            fazerLogin(); // Tenta logar direto
        }
    }

    async function sair() {
        await supabase.auth.signOut();
        window.location.reload();
    }

    // Verifica se j√° tem sess√£o ativa ao abrir
    window.onload = async () => {
        const { data: { session } } = await supabase.auth.getSession();
        if (session) {
            entrarNoApp(session.user);
        }
        
        // Recupera perfil local
        if(localStorage.getItem('runai_age')) document.getElementById('idade').value = localStorage.getItem('runai_age');
        if(localStorage.getItem('runai_level')) document.getElementById('nivel').value = localStorage.getItem('runai_level');
    };

    function entrarNoApp(user) {
        usuarioAtual = user;
        document.getElementById('authScreen').style.display = 'none';
        document.getElementById('appScreen').style.display = 'block';
        document.getElementById('body').style.alignItems = 'flex-start'; // Ajuste layout
        document.getElementById('userDisplay').innerText = user.email;
    }

    // --- ENVIO DO TREINO ---
    async function enviarTreino() {
        if (!usuarioAtual) return alert("Voc√™ precisa estar logado!");

        const btn = document.getElementById('btnEnviar');
        const resultadoDiv = document.getElementById('resultado');
        btn.innerText = "Processando...";
        btn.disabled = true;

        // Salva perfil localmente para facilitar
        localStorage.setItem('runai_age', document.getElementById('idade').value);
        localStorage.setItem('runai_level', document.getElementById('nivel').value);

        const dados = {
            user_id: usuarioAtual.id, // USA O ID SEGURO DO SUPABASE (UUID)
            idade: parseInt(document.getElementById('idade').value),
            nivel: document.getElementById('nivel').value,
            km: parseFloat(document.getElementById('km').value),
            tempo: parseFloat(document.getElementById('tempo').value),
            calorias: 0, 
            esforco: parseInt(document.getElementById('esforco').value),
            clima: "Indefinido"
        };

        try {
            const req = await fetch('/registrar_treino', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(dados)
            });
            const res = await req.json();
            mostrarPrescricao(res.analise);
        } catch (e) {
            alert("Erro: " + e);
        } finally {
            btn.innerText = "ANALISAR PERFORMANCE";
            btn.disabled = false;
        }
    }

    function mostrarPrescricao(data) {
        const div = document.getElementById('resultado');
        const badge = document.getElementById('statusBadge');
        
        let corBg = "#dcfce7", corTxt = "#166534";
        if(data.status.includes("RISCO")) { corBg = "#fee2e2"; corTxt = "#991b1b"; }
        else if(data.status.includes("BAIXA")) { corBg = "#fef3c7"; corTxt = "#92400e"; }

        badge.style.background = corBg; 
        badge.style.color = corTxt;
        badge.innerText = data.status;

        document.getElementById('msgAnalise').innerText = data.mensagem;
        document.getElementById('acaoRecomendada').innerText = data.acao;
        document.getElementById('proximoTreino').innerText = data.proximo_treino;

        div.style.display = 'block';
        div.scrollIntoView({behavior: 'smooth'});
    }
</script>
</body>
</html>
